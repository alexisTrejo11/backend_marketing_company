# ============================================
# APPLICATION CONFIGURATION
# ============================================
spring:
  application:
    name: MarketingCRMCompany
    version: 2.0.0

  # ============================================
  # DATABASE CONFIGURATION (PostgreSQL)
  # ============================================
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:marketing_company_db}
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:postgres}
    driver-class-name: org.postgresql.Driver
    hikari:
      connection-timeout: 30000
      maximum-pool-size: 20
      minimum-idle: 5
      idle-timeout: 600000
      max-lifetime: 1800000
      pool-name: CRM-HikariPool
      connection-test-query: SELECT 1

  # ============================================
  # JPA / HIBERNATE CONFIGURATION
  # ============================================
  jpa:
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    hibernate:
      ddl-auto: validate
      naming:
        physical-strategy: org.hibernate.boot.model.naming.CamelCaseToUnderscoresNamingStrategy
      use-new-id-generator-mappings: true
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true
        default_batch_fetch_size: 20
        generate_statistics: false
        connection:
          autocommit: false

  # ============================================
  # GRAPHQL CONFIGURATION
  # ============================================
  graphql:
    path: /graphql
    websocket:
      path: /subscriptions
      connection-init-timeout: 60s
    schema:
      printer:
        enabled: true
      introspection-enabled: true
      locations:
        - classpath:graphql/**/
      file-extensions: .graphqls, .gqls, .graphql
    exception-handlers-enabled: true
    exception:
      include-stacktrace: on_parameter
      include-message: always
    cors:
      allowed-origins: "http://localhost:3000,http://localhost:8080"
      allowed-methods: "GET,POST,OPTIONS"
      allowed-headers: "*"
      allow-credentials: true
    graphiql:
      enabled: true
      path: /graphiql
      title: CRM GraphQL API
      theme: light
    voyager:
      enabled: false
      path: /voyager
      display-request-editor: true
    playground:
      enabled: false
    metrics:
      enabled: true
      tag:
        path: true
        outcome: true
    logging:
      enabled: true
      execution:
        errors: true
        data-fetcher: false

  # ============================================
  # WEB CONFIGURATION
  # ============================================
  web:
    resources:
      add-mappings: false
    locale: en_US
    encoding:
      charset: UTF-8
      enabled: true
      force: true

  # ============================================
  # SERVER CONFIGURATION
  # ============================================
  server:
    port: 8080
    servlet:
      context-path: /api
      encoding:
        charset: UTF-8
        enabled: true
        force: true
    compression:
      enabled: true
      mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json
      min-response-size: 1024
    error:
      include-stacktrace: always
      include-exception: false
      include-message: always
      include-binding-errors: always

  # ============================================
  # ACTUATOR / METRICS
  # ============================================
  management:
    endpoints:
      web:
        exposure:
          include: health,info,metrics,prometheus
        base-path: /actuator
    endpoint:
      health:
        show-details: always
        probes:
          enabled: true
    metrics:
      export:
        prometheus:
          enabled: true
      tags:
        application: ${spring.application.name}
      distribution:
        percentiles-histogram:
          http.server.requests: true
      enable:
        jvm: true
        system: true
        logback: true

  # ============================================
  # LOGGING CONFIGURATION
  # ============================================
  logging:
    level:
      at.backend.MarketingCompany: DEBUG
      org.springframework: INFO
      org.springframework.transaction: DEBUG
      org.springframework.orm.jpa: DEBUG
      org.springframework.graphql: DEBUG
      graphql: WARN
      graphql.execution: WARN
      org.hibernate.SQL: DEBUG
      org.hibernate.type.descriptor.sql: TRACE
      org.hibernate.stat: DEBUG
      com.fasterxml.jackson.databind: WARN
    pattern:
      console: "%d{yyyy-MM-dd HH:mm:ss} - %highlight(%-5level) - %cyan(%logger{36}) - %msg%n"
      file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file:
      name: logs/crm-application.log
      max-size: 10MB
      max-history: 30
      total-size-cap: 1GB

  # ============================================
  # REDIS CONFIGURATION
  # ============================================
  data:
    redis:
      host: ${SPRING_REDIS_HOST:localhost}
      port: ${SPRING_REDIS_PORT:6379}
      timeout: 60000
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms

  # ============================================
  # CACHE CONFIGURATION
  # ============================================
  cache:
    type: caffeine
    caffeine:
      spec: maximumSize=1000,expireAfterAccess=3600s

  # ============================================
  # SCHEDULER / ASYNC
  # ============================================
  task:
    execution:
      pool:
        core-size: 5
        max-size: 20
        queue-capacity: 100
      thread-name-prefix: CRM-Task-
    scheduling:
      pool:
        size: 5
      thread-name-prefix: CRM-Scheduler-

# ============================================
# APPLICATION-SPECIFIC PROPERTIES
# ============================================
app:
  name: CRM
  version: 1.0.0
  description: Customer Relationship Management System

  security:
    jwt:
      secret: ${JWT_SECRET:your-256-bit-secret-key-change-this-in-production}
      expiration: 86400000
      issuer: CRM-Service

  pagination:
    default-page-size: 20
    max-page-size: 100

  cache:
    company:
      ttl: 300
    customer:
      ttl: 600

  retry:
    max-attempts: 3
    backoff-delay: 1000
    multiplier: 2.0

  rate-limit:
    global:
      enabled: true
      max-requests: 5000
      duration-hours: 1

    defaults:
      max-requests: 100
      duration-seconds: 60

    endpoints:
      sensitive:
        max-requests: 7
        duration-seconds: 60

      standard:
        max-requests: 30
        duration-seconds: 60

      strict:
        max-requests: 5
        duration-seconds: 300

      public:
        max-requests: 500
        duration-seconds: 60

      user-operation:
        max-requests: 60
        duration-seconds: 60

      resource-mutation:
        max-requests: 10
        duration-seconds: 60

  cors:
    # Allowed origins - domains that can make requests to this API
    allowed-origins:
      - http://localhost:3000
      - http://localhost:5173
      - http://localhost:8080 # Local testing

    # Allowed HTTP methods
    allowed-methods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS

    # Allowed request headers (* allows all)
    allowed-headers:
      - "*"

    # Headers exposed to the browser (so JavaScript can read them)
    exposed-headers:
      - X-RateLimit-Global-Limit
      - X-RateLimit-Global-Remaining
      - X-RateLimit-Global-Reset
      - X-RateLimit-Global-Window
      - X-RateLimit-Operation-Limit
      - X-RateLimit-Operation-Remaining
      - X-RateLimit-Operation-Reset
      - X-RateLimit-Operation-Window
      - X-RateLimit-Operation-Name
      - X-RateLimit-Operation-Profile
      - X-Total-Count
      - X-Page-Number
      - X-Page-Size

    # Allow credentials (cookies, authorization headers)
    allow-credentials: true

    # Cache preflight requests for 1 hour
    max-age: 3600

  upload:
    max-file-size: 10MB
    allowed-extensions: .pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg
    temp-dir: ./temp-uploads

  email:
    from: no-reply@crm-system.com
    enabled: false
    retry-count: 3

  notifications:
    webhook:
      enabled: false
      url: ${WEBHOOK_URL:}
    slack:
      enabled: false
      webhook-url: ${SLACK_WEBHOOK_URL:}

  monitoring:
    enabled: true
    trace:
      sampling-rate: 0.1
    metrics:
      enabled: true

  features:
    company-analytics: true
    real-time-notifications: false
    advanced-search: true
    bulk-operations: false

# ============================================
# DATABASE MIGRATION (FLYWAY)
# ============================================
flyway:
  enabled: true
  locations: classpath:db/migration
  baseline-on-migrate: true
  baseline-version: 1
  validate-on-migrate: true
  out-of-order: false
  clean-disabled: true
  table: flyway_schema_history

# ============================================
# RESILIENCE4J CONFIGURATION
# ============================================
resilience4j:
  circuitbreaker:
    instances:
      companyService:
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 5s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
  retry:
    instances:
      externalApiCall:
        maxAttempts: 3
        waitDuration: 1s
        retryExceptions:
          - java.net.ConnectException
          - java.net.SocketTimeoutException
        ignoreExceptions:
          - java.lang.IllegalArgumentException
  ratelimiter:
    instances:
      graphqlApi:
        limitForPeriod: 100
        limitRefreshPeriod: 1m
        timeoutDuration: 5s
  timelimiter:
    instances:
      slowService:
        timeoutDuration: 5s

---
# DEVELOPMENT PROFILE
spring:
  config:
    activate:
      on-profile: dev

  jpa:
    show-sql: true
    properties:
      hibernate:
        format_sql: true

  graphql:
    graphiql:
      enabled: true
    exception:
      include-stacktrace: always

  logging:
    level:
      at.backend.MarketingCompany: DEBUG
      org.hibernate.SQL: DEBUG
      org.hibernate.type.descriptor.sql: TRACE

  devtools:
    restart:
      enabled: true

app:
  features:
    company-analytics: true
    real-time-notifications: false

---
# PRODUCTION PROFILE
spring:
  config:
    activate:
      on-profile: prod

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false

  graphql:
    graphiql:
      enabled: false
    introspection: false
    exception:
      include-stacktrace: never
      include-message: on_parameter

  logging:
    level:
      at.backend.MarketingCompany: INFO
      org.springframework: WARN

app:
  email:
    enabled: true
  monitoring:
    enabled: true
  security:
    jwt:
      secret: ${JWT_SECRET}

---
# DOCKER PROFILE
spring:
  config:
    activate:
      on-profile: docker

  datasource:
    url: jdbc:postgresql://postgres:5432/${POSTGRES_DB:marketing_company_db}
    username: ${POSTGRES_USER:postgres}
    password: ${POSTGRES_PASSWORD:postgres}

  data:
    redis:
      host: ${SPRING_REDIS_HOST:redis}
      port: ${SPRING_REDIS_PORT:6379}

  jpa:
    show-sql: true
    properties:
      hibernate:
        format_sql: true

  logging:
    level:
      at.backend.MarketingCompany: INFO
      org.springframework: INFO

---
# TEST PROFILE
spring:
  config:
    activate:
      on-profile: test

  datasource:
    url: jdbc:h2:mem:testdb
    driver-class-name: org.h2.Driver
    username: sa
    password:

  jpa:
    database-platform: org.hibernate.dialect.H2Dialect
    hibernate:
      ddl-auto: generate-drop

  graphql:
    graphiql:
      enabled: false

  logging:
    level:
      at.backend.MarketingCompany: WARN
